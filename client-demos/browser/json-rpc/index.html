<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>JSON-RPC Javascript test</title>

    <script src="service.js"></script>

</head>
<body>

<script>


    (function () {

        var vr = 47
        var stop = 0.1
        var stepSize = 1.0 / 100

        var that = this
        this.slaveid = undefined

        var service = new Service("localhost", 9099)
        service.onOpen(function () {

            service.load("http://folk.ntnu.no/laht/files/ControlledTemperature.fmu")
                .then(function (fmuId) {
                    return service.createInstanceFromCS(fmuId)
                })
                .then(function (slaveId) {
                    that.slaveId = slaveId
                    return service.simpleSetup(slaveId)

                })
                .then(function (status) {

                    var read = function () {
                        return service.readReal(that.slaveId, [vr])
                    }

                    var doStep = function() {
                        return service.doStep(that.slaveId, stepSize).then(function (info) {
                            if (info.simulationTime <= stop) {
                                return read().then(function (read) {
                                    console.log("Real with valueReference " + vr + " = " + read.value)
                                    return doStep()
                                })
                            } else Â {
                                return info
                            }
                        })
                    }
                    return doStep()

                })
                .then(function (info) {
                    return service.terminate(that.slaveId)
                })
                .then(function (status) {
                    service.close()
                })

        })


    })();

</script>

</body>
</html>
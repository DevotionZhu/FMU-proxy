plugins {
    id 'java-library'
}

apply from: rootProject.file("gradle/mavenpublish.gradle")

dependencies {

    api group: 'org.apache.thrift', name: 'libthrift', version: '0.12.0'
    implementation("javax.annotation:javax.annotation-api:1.3.2")

}

apply from: rootProject.file("gradle/bintraypublish.gradle")


if (!getProperties().get("disableCodeGeneration", false)) {

    def definitions = "../thrift"
    def generatedSrcDir = "build/generated/java"
    new File(generatedSrcDir).mkdirs()

    task generateThrift {

        doLast {

            def out = new File("src/main/java")
            if (!out.exists()) {
                out.mkdirs()
            }

            try {

                exec {
                    executable 'thrift'
                    args '-r', '-out', generatedSrcDir, '--gen', 'java:private-members,fullcamel',
                            "$definitions/defs.thrift"
                }
                exec {
                    executable 'thrift'
                    args '-r', '-out', generatedSrcDir, '--gen', 'java:private-members,fullcamel',
                            "$definitions/service.thrift"
                }
                exec {
                    executable 'thrift'
                    args '-r', '-out', generatedSrcDir, '--gen', 'java:private-members,fullcamel',
                            "$definitions/internal_service.thrift"
                }

            } catch (Exception ex) {
                println ex
            }

        }

        group 'thrift'
        compileJava.dependsOn generateThrift

    }

    sourceSets.main.java.srcDirs += generatedSrcDir

}
